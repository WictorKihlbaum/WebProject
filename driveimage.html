<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
        <meta name="google-signin-client_id" content="788591829115-1uq193qnm8r72ujqej7l3hdj558hj7ej.apps.googleusercontent.com">
		<title>WebProject Edit Drive Image</title>
        <!-- Skeleton CSS Framework -->
        <link rel="stylesheet" type="text/css" href="css/normalize.css">
        <link rel="stylesheet" type="text/css" href="css/skeleton.css">
        <!-- Mainstyle CSS -->
        <link rel="stylesheet" type="text/css" href="css/mainstyle.css">
        <!-- Navigation CSS -->
        <link rel="stylesheet" type="text/css" href="css/nav.css">
        <!-- Button-styles -->
        <link rel="stylesheet" type="text/css" href="css/buttons.css">
        <!-- Drive Image Subpage CSS -->
        <link rel="stylesheet" type="text/css" href="css/driveimage.css">
        <!-- Contact Subpage CSS -->
        <link rel="stylesheet" type="text/css" href="css/contact.css">
	</head>
	<body>
    	<header>
        	<h1>Web Project</h1>
            <!-- Google login/logout button -->
            <div class="g-signin2" data-onsuccess="App.onSignIn"></div>
            <a href="#" id="signout-button" onClick="App.signOut()">Sign out</a>
        </header>
        <main>
        	<nav>
            	<ul>
                	<li id="active"><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            
            <div id="top-text">
            	You have to authorize to be able to load your Google Drive images. 
                However, if you already have done so you should be able to see your images right away.
                Only images in formats Png and Jpeg/Jpg will be shown. This is the formats the Aviary editor accepts.
            </div>
            
            <div id="au-div">
                <div id="authorize-div" style="display: none">
                    <p>Authorize access to Google Drive</p>
                    <!--Button for the user to click to initiate auth sequence -->
                    <button id="authorize-button" onclick="handleAuthClick(event);">
                        Authorize
                    </button>
                </div>
            </div>
            
            <div id="image-div">
            	<ul id="image-list">
                	<!-- li-tags are being added from ???.js -->
                </ul>
            </div>
            <p>
            	<a href="index.html" class="button-class go-back-button">Go back</a>
            </p>
            
        </main>
        <footer>
        	<p class="footer-text">Contact</p>
            <div id="contact-circles-container">
                <a href="https://www.facebook.com/wictor.kihlbaum">
                    <div class="contact-circles" id="facebook-circle"></div>
                </a>
                <a href="https://twitter.com/WictorKihlbaum">
                    <div class="contact-circles" id="twitter-circle"></div>
                </a>
                <div class="contact-circles" id="google-circle" data-clipboard-text="wictor.kihlbaum@gmail.com" title="Copy email to clipboard"></div>
            </div>
            <p id="copyright">Â© 2016 Webbteknik 2 Projekt</p>
        </footer>
        
        <!-- Load Feather code -->
		<script type="text/javascript" src="http://feather.aviary.com/imaging/v2/editor.js"></script>
        <!-- DriveClass JS -->
        <script src="js/DriveClass.js"></script>
        
        <script type="text/javascript">
		
			  var imageList = document.getElementById("image-list");
			  var CLIENT_ID = '788591829115-1uq193qnm8r72ujqej7l3hdj558hj7ej.apps.googleusercontent.com';
			  var SCOPES = ['https://www.googleapis.com/auth/drive']; // change?
			  //var images = [];
		
			  /**
			   * Check if current user has authorized this application.
			   */
			  function checkAuth() {
				gapi.auth.authorize(
				  {
					'client_id': CLIENT_ID,
					'scope': SCOPES.join(' '),
					'immediate': true
				  }, handleAuthResult);
			  }
		
			  /**
			   * Handle response from authorization server.
			   *
			   * @param {Object} authResult Authorization result.
			   */
			  function handleAuthResult(authResult) {
				var authorizeDiv = document.getElementById('authorize-div');
				if (authResult && !authResult.error) {
				  // Hide auth UI, then load client library.
				  authorizeDiv.style.display = 'none';
				  loadDriveApi();
				} else {
				  // Show auth UI, allowing the user to initiate authorization by
				  // clicking authorize button.
				  authorizeDiv.style.display = 'inline';
				}
			  }
		
			  /**
			   * Initiate auth flow in response to user clicking authorize button.
			   *
			   * @param {Event} event Button click event.
			   */
			  function handleAuthClick(event) {
				gapi.auth.authorize(
				  {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
				  handleAuthResult);
				return false;
			  }
		
			  /**
			   * Load Drive API client library.
			   */
			  function loadDriveApi() {
				gapi.client.load('drive', 'v2', listFiles);
			  }
		
			  /**
			   * Print files.
			   */
			  function listFiles() {
			  	var request = gapi.client.drive.files.list({
					'maxResults': 10
			  	});
		
				  request.execute(function(resp) {
					  
					var files = resp.items;
					if (files && files.length > 0) {
						
					  	for (var i = 0; i < files.length; i++) {
							
							var file = files[i];
						
							if (file.fileExtension == 'png' || 
								file.fileExtension == 'jpg' || 
								file.fileExtension == 'jpeg') {
							
								renderListElement(file);
							}
						}
					  
					} else {
						
						document.getElementById("image-div").innerHTML = "No images found in your Google Drive";
					}
				  });
			  }
			  
			  function renderListElement(image) {
				  
				  imageList.innerHTML += 
				  	'<li>' + // "crossOrigin="Anonymous"" enables image to be opened with Aviary editor. 
						'<img id="'+image.id+'" class="thumbnail-image" src="'+image.thumbnailLink+'" alt="'+image.originalFilename+'" crossOrigin="Anonymous" />' +
						'<span class="image-name">'+image.originalFilename+'</span>' +
						'<a href="#" class="button-class edit-button" onclick="downloadFile(\'' + image.id + '\', \'' + image.downloadUrl + '\')">Edit</a>' +
						'<a href="'+image.webContentLink+'" download class="button-class download-button">Download original</a>' +
					'</li>';
			  }	
				
				function downloadFile(id, downloadURL) {
					
					if (downloadURL) {
						
						var accessToken = gapi.auth.getToken().access_token;
						var xhr = new XMLHttpRequest();
					
						xhr.onreadystatechange = function() {

							if (xhr.readyState === 4 && xhr.status === 200) {
								
								var blob = xhr.response;
								
								var url = window.URL.createObjectURL(blob);
								
								//var img = document.getElementById(id);
								//img.src = window.URL.createObjectURL(blob);
								
								// Call Aviary Editor.
								DriveClass.setCurrentID(id);
								DriveClass.launchEditor(id, url);								
							}
						}
						
						xhr.open('GET', downloadURL);
						xhr.responseType = 'blob';
						xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
						xhr.send();
					}
				}
	  
	  </script>
        
        <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
        
        <!-- Google Platform Library -->
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        <!-- App JS -->
        <script src="js/App.js"></script>
        
        <!-- Clipboard JS -->
        <script src="js/clipboard.js-master/dist/clipboard.min.js"></script>
        <script src="js/ClipboardClass.js"></script>
        
    </body>
</html>
